<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>抽獎</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/bounce.css">
  <script src="/scripts/common.js"></script>
</head>
<body>
  <div class="container">
    <!-- 主圖 -->
    <div class="image-wrapper">
      <img src="/images/Lucky-Draw/750-UI_扭蛋.gif" alt="扭蛋圖片" class="main-image">

      <!-- 單一抽獎按鈕 -->
      <div class="action-container">
        <button class="button <%= eligibleTasks.length === 0 ? 'disabled' : '' %>" 
                id="lotteryImage" 
                <%= eligibleTasks.length === 0 ? 'disabled' : '' %>>
          <img src="/images/Lucky-Draw/Lucky-Draw-CTA.png" alt="抽獎按鈕圖片">
        </button>
      </div>
    </div>
  </div>

  <!-- 彈窗容器 -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <img id="popupImage" src="" alt="彈窗圖片">
      <img id="closePopup" class="close-popup" src="/images/Lucky-Draw/X.png" alt="關閉按鈕">
    </div>
  </div>
  <div id="freezeLayer" class="hidden"></div>

  <script>
    const freezeLayer = document.getElementById('freezeLayer');
    const popup = document.getElementById('popup');
    const popupImage = document.getElementById('popupImage');
    const closePopup = document.getElementById('closePopup');
    const lotteryImage = document.getElementById('lotteryImage');

    // 解密參數儲存
    const query = new URLSearchParams(window.location.search).get('query');
    if (query && !sessionStorage.getItem('ContactId')) {
      sessionStorage.setItem('ContactId', '<%= contactId %>');
      sessionStorage.setItem('Query', '<%= query %>');
      console.log('ContactId 和 Query 已存儲到 sessionStorage');
    }

    // 關閉彈窗
    closePopup.addEventListener('click', () => {
      popup.classList.add('hidden');
    });

    // 抽獎按鈕事件
    lotteryImage?.addEventListener('click', () => {
      if (lotteryImage.disabled) {
        alert('目前無可抽的任務，請稍後再試！');
        return;
      }

      freezeLayer.classList.add('active');
      navigateToParent('Draw_start');

      const userId = sessionStorage.getItem('ContactId');
      const eligibleTasks = <%- JSON.stringify(eligibleTasks) %>;
      const selectedTask = eligibleTasks[0]; // ✅ 只抽第一個任務

      if (!selectedTask) {
        alert('目前無可抽的任務');
        freezeLayer.classList.remove('active');
        return;
      }

      fetch('/lottery/perform-lottery', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, taskId: selectedTask.taskId })
      })
        .then(response => response.json())
        .then(data => {
          freezeLayer.classList.remove('active');
          lotteryImage.disabled = true;
          lotteryImage.classList.add('disabled');

          if (selectedTask.taskId === 8) {
            if (data.success) {
              popupImage.setAttribute('src', '/images/Lucky-Draw/Lucky-Draw-3.png');

            } else {
              popupImage.setAttribute('src', '/images/Lucky-Draw/Lucky-Draw-4.png');
            }
            // ✅ 任務 8 點擊圖片導向 dummy-site
            popupImage.onclick = () => {
              navigateToParent('dummy-site');
            };


          }  else   {
                  if (data.success) {
              popupImage.setAttribute('src', '/images/Lucky-Draw/Lucky-Draw-1.png');
                } else {
                  popupImage.setAttribute('src', '/images/Lucky-Draw/Lucky-Draw-2.png');
              }
          }
        
          popup.classList.remove('hidden');
        })
        .catch(error => {
          console.error('抽獎出錯:', error);
          freezeLayer.classList.remove('active');
        });
    });
  </script>
</body>
</html>