<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任務總表</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/stylesheets/task-list.css">
    <script src="/scripts/common.js" ></script>
</head>
<body>
    <header>
        <!-- 獎勵圖片區域 -->
        <div class="reward-banner">
            <% 
                    // 計算獎勵百分比（已處理特定範圍）
                    let rewardLevel = 0;
                    
                    if (user.rewards >= 75 && user.rewards <= 99) {
                        rewardLevel = 75; // 75 到 99 對應獎勵 75
                    } else if (user.rewards >= 100) {
                        rewardLevel = 100; // 100 以上對應獎勵 100
                    } else {
                        const rounded = Math.ceil(user.rewards / 5) * 5;
                        rewardLevel = (rounded <= 5) ? 5 : rounded;
                    }
                    
                    // 設定圖片名稱
                    const rewardImage = `pig-$${rewardLevel}.gif`;
            %>
            
            <!-- 顯示對應的獎勵圖片 -->
            <div class="reward-container">
                <img src="/images/Reward/<%= rewardImage %>" alt="獎勵圖片" class="reward-image">
                <span class="reward-amount">
                    <img src="/images/Reward/coin_03.png" alt="金幣圖示" class="coin-icon">
                    <%= typeof user.rewards !== 'undefined' && user.rewards !== null ? user.rewards : 0 %> 元
                </span>
            </div>
            
        </div>
    </header>
    <main>
        <!-- 任務按鈕區域 -->
        <div class="task-list">
            <% 
                tasks.sort((a, b) => a.TaskID - b.TaskID);
                const maxTaskId = Math.max(...tasks.map(t => t.TaskID));
                tasks.forEach((task) => {
                    const startDate = new Date(task.StartDate).toISOString().slice(0, 10);
                    const endDate = new Date(task.EndDate).toISOString().slice(0, 10);
                    const today = new Date(currentDate);

                    const isToday = today >= new Date(task.StartDate) && today <= new Date(task.EndDate);
                    const isPast = today > new Date(task.EndDate);
                    const isFuture = today < new Date(task.StartDate);

                    // 計算倒序的 TaskID
                    //const reverseTaskId = maxTaskId - task.TaskID + 1;
                
                    // 動態設置按鈕圖片
                    // 判斷任務圖片：如果是今日任務、過去任務或未解鎖
                    const taskImage = task.IsCompleted || isPast
                             ? `/images/Task-list/pasttask/CTA-past task_M${task.TaskID}.png`
                            : isToday
                            ? `/images/Task-list/todaytask/CTA-today task_M${task.TaskID}.png`
                            : `/images/Task-list/futuretask/CTA-future task_M${task.TaskID}.png`;

        
                    // 如果是未解鎖的任務，設置 disabled
                    const isLocked = isFuture; // 未來任務為未解鎖

            %>
                <button 
                    class="task-button <%= isLocked ? 'locked' : '' %>" 
                    <%= isLocked ? 'disabled' : '' %> 
                    onclick="<%= isLocked ? '' : `redirectToTask('${task.TaskID}')` %>"
                >
                    <img src="<%= taskImage %>" alt="任務圖片">
                     <% if (task.ShowDrawReminder) { %>
                        <div class="draw-reminder">
                            加碼抽未完成
                        </div>
                        <% } %>
                </button>
            <% }); %>
        </div>
        <img src="/images/每日任務_bg_Footer.jpg" alt="背景裝飾" style="max-width: 100%; margin: 35px auto 0; display: block;width: 100%;" />
           <img
    src="/images/backgroundscorllcolor.jpg"
    alt="背景裝飾"
    style="max-width: 100%; margin: 35px auto 0; display: block;width: 100%;"
  />
      <script>
          function redirectToTask(taskId) {
            navigateToParent(`task-${taskId}`)
              // 獲取當前 URL 的查詢參數
              //const queryParams = new URLSearchParams(window.location.search);
              // 生成目標 URL，保留查詢參數
              //const targetUrl = `/task/${taskId}?${queryParams.toString()}`;
              // 重定向到新頁面
              //window.location.href = targetUrl;
          }
      </script>
      
      
    </main>
</body>
</html>
